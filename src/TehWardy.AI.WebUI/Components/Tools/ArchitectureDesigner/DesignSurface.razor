@using TehWardy.AI.WebUI.Models.Tools.ArchitectureDesigner

<div class="designer"
     tabindex="0"
     @onwheel="OnWheel"
     @onmousedown="OnMouseDown"
     @onmousemove="OnMouseMove"
     @onmouseup="OnMouseUp"
     @onmouseleave="OnMouseUp">

    <svg class="designer-svg"
         xmlns="http://www.w3.org/2000/svg"
         viewBox="0 0 @ComputedLayout.Width @ComputedLayout.Height"
         preserveAspectRatio="xMinYMin meet">

        <defs>
            <marker id="arrow" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto">
                <path d="M 0 0 L 10 5 L 0 10 z" class="edge-arrow"></path>
            </marker>
        </defs>

        <g transform="translate(@PanX @PanY) scale(@Zoom)">

            @{
                var nodes = Diagram.Nodes ?? Array.Empty<DiagramNode>();
                var edges = Diagram.Edges ?? Array.Empty<DiagramEdge>();

                var nodeMap = nodes.ToDictionary(n => n.Name, StringComparer.Ordinal);
                var anchors = BuildAnchors(nodeMap);
            }

            <!-- NODES -->
            @foreach (var node in nodes)
            {
                <DiagramNodeComponent ComputedLayout="@ComputedLayout"
                                      Node="@node"
                                      HeaderH="@HeaderH"
                                      Padding="@Padding"
                                      MethodGap="@MethodGap"
                                      LineH="@LineH"
                                      MethodTopPad="@MethodTopPad"
                                      MethodBottomPad="@MethodBottomPad"
                                      MethodLabelBlockH="@MethodLabelBlockH" />

            }

            <!-- EDGES (method-to-method) -->
            @foreach (var edge in edges)
            {
                if (!nodeMap.TryGetValue(edge.FromNodeName, out var fromNode) ||
                !nodeMap.TryGetValue(edge.ToNodeName, out var toNode))
                {
                    continue;
                }

                var fromMethod = ResolveFromMethodName(fromNode, edge);
                var toMethod = ResolveToMethodName(toNode, edge);

                var fromKey = AnchorKey(edge.FromNodeName, fromMethod, AnchorSide.Right);
                var toKey = AnchorKey(edge.ToNodeName, toMethod, AnchorSide.Left);

                // Fallback: if method anchor missing (e.g. node has no methods), use node-center anchors
                // If either still invalid (missing layout), skip
                if (!anchors.TryGetValue(fromKey, out Anchor a) || !anchors.TryGetValue(toKey, out Anchor b))
                    continue;

                var path = BuildElbowPath(a.X - Padding, a.Y, b.X + Padding, b.Y);

                <path d="@path" class="edge" marker-end="url(#arrow)" />
            }
        </g>
    </svg>
</div>
